# 日字预处理

## 使用方法（应知必会）

1. 解压 `EmEditor.7z`，得到一个文件夹和一个脚本。文件夹是预处理用的文本编辑器的程序，脚本是一个快捷方式。
2. 双击 `快捷方式启动.cmd`。
3. 把台本（日字的 ass 文件）拖进去。
4. 按 `Ctrl + H`，点右边的 `批处理 >>`，导入 `预处理规则.tsv`。
5. 点 `批处理替换全部`。

注：编辑器会记住导入过的脚本，第二次使用可以跳过第 4 步。

## 预处理规则解释（进阶）

预处理规则会根据日字的 ass 文件（通过正则替换、纯文本替换等方法）产生一个基本可以用的纯文本日字文件。由于规则比较复杂，现在只把已解明的部分记录在这里。如果大家在使用的时候发现新的问题，可以反馈给懂的成员或者根据这里和下一部分的提示自己尝试增加规则。目前维护这个规则的时候其实也是遇到 bug 才现去读的，所以基本思路是需要多少解明多少。

注意 1：如果在中间插入了新的规则，**记得更新一下这个文档里面记载的行号**，好让后人知道都在做什么。

注意 2：部分规则最初处于关闭状态，如果需要使用，请自己改为 `on` 或在导入后点击选择框启用。（**请勿在本仓库里直接修改**，复制一份再改）

* 1 ~ 73 行：不要管它，直接用即可。
* 74 ~ 75 行：【BUG 修正】解决因 76 行暴力删除 `～` 导致本应处理成 `もう/まあ` 的 `も～/ま～` 被错误地处理为 `も/ま` 的问题。由于存在顺序问题，必须在 76 行之前解决。
* 76 行：【BUG 警告】这一行只是做了一些简单的正则替换。值得注意的是这一行暴力删除了 `～`，会导致 `も～/ま～` 的处理错误。调试中发现不能简单修改正则删去 `～`  的部分，因为后面的规则会依赖被暴力删掉的波浪线来清理一些不必要的语气词和拟声词。
* 77 ~ 140 行：不要管它，直接用即可。
* 141 ~ 143 行：【处理优化】将台本里的引号和非常规的中点相应替换为正确的符号。
* 144 ~ 145 行：【处理优化】给类似 `い　いえ` 的语气停顿的说法之间加一个省略号，这里有两个版本，分别是替换后不带全角空格和带一个全角空格的版本，只需启用（on）一个版本即可。
* 146 ~ 151 行：【处理优化 / 待改进】解决偶尔出现的 `どういうこと` 中的 `こと` 写成汉字 `事` 的问题。目前只提供了一种不太优雅的临时解决办法。
* 152 ~ 153 行：【处理优化】将纯英文 / 数字词语之间的全角空格替换为半角空格。
* 154 ~ 164 行：【处理优化】将一些用小写的假名表示的长音都替换成大写的假名。
* 165 ~ 184 行：【处理优化】将一些台本原文中因被认为不太常见而用假名代替的日文汉字还原为原本的日文汉字。

## 怎么读 / 写预处理规则（高级）

最后记录一下怎么看懂这些预处理规则以及自己要写怎么写。如果你对自己的正则表达式有信心，可以直接修改  tsv 文件。如果不会可以花 30 分钟时间[学一下正则表达式](https://deerchao.cn/tutorials/regex/regex.htm)，还挺简单的呢。

### tsv 文件的基本格式

| 列号 | 1                | 2        | 3      | 4              |
| ---- | ---------------- | -------- | ------ | -------------- |
| 意义 | 开关（on / off） | 查找目标 | 替换为 | 条件（见后文） |

* 开关：顾名思义。`on` 是启用，`off` 是关闭。这里的开关指的是导入时的最初状态，导入后可以在列表里自行通过选择框开关。关闭的规则将在批处理时被跳过。

* 查找目标：顾名思义。根据条件不同，可以是被替换的文本，也可以是匹配用的正则表达式。

* 替换为：将查找目标替换为指定文本（可以含有正则表达式匹配[分组](https://deerchao.cn/tutorials/regex/regex.htm#backreference)）。

* 条件：这部分直接引用手册里找到的原文。

  ```
  List box
  Displays the list of find and replace combinations to be used for the batch process. The following abbreviations are used for the Condition column.
  
  C
  Match Case
  
  R
  Use Regular Expressions
  
  W
  Search Only Word
  
  E
  Match Only Embedded Newlines in CSV
  
  S
  Treat CR and LF Separately
  
  D
  Regular Expression "." can Match Newlines
  
  B
  Use Boost.Regex as the Regular Expression Engine
  
  O
  Use Onigmo as the Regular Expression Engine
  ```

### 一点调试技巧

* 调试时无需反复全选删除再导入，双击某一行即会被填写到左边的 `查找` 和 `替换为` 中，条件也会反应在左半边（区分大小写、使用正则表达式、使用转义符、只搜索单词等）。修改完后直接点击 `修改` 按钮，修改后的版本就会覆盖到右边。